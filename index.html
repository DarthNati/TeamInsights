<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Support - Staff Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f4f6f9;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        #insights {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .insight-section {
            margin-bottom: 20px;
        }
        .highlight {
            background-color: #f0f4f8;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .warning {
            color: #d94d4d;
            font-weight: 600;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid #e2e8f0;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f1f5f9;
            font-weight: 600;
        }
        .collapsible {
            background-color: #f1f5f9;
            color: #333;
            cursor: pointer;
            padding: 10px;
            width: 100%;
            border: none;
            text-align: left;
            font-size: 16px;
        }
        .collapsible:after {
            content: '\002B'; /* Plus sign */
            font-size: 18px;
            color: #777;
            float: right;
        }
        .active:after {
            content: '\2212'; /* Minus sign */
        }
        .content {
            padding: 0;
            display: none;
            overflow: hidden;
            background-color: #f9f9f9;
            margin-top: 10px;
        }
        .content table {
            margin-bottom: 0;
        }
        select {
            padding: 5px 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Team Vacation Insights</h1>
        <div id="insights">
            <div id="vacation-summary" class="insight-section">
                <h2>Vacation Summary</h2>
                <p id="loading-message">Loading vacation data...</p>
            </div>
            <div id="team-vacations" class="insight-section">
                <!-- Dropdown for selecting the number of unavailable members -->
                <label for="minUnavailableMembers">Select minimum number of unavailable members:</label>
                <select id="minUnavailableMembers">
                    <option value="1">1 member</option>
                    <option value="2">2 members</option>
                    <option value="3">3 members</option>
                    <option value="4">4 members</option>
                    <option value="5">5 members</option>
                    <option value="6">6 members</option>
                    <option value="7">7 members</option>
                </select>

                <!-- Dropdown for selecting groups -->
                <label for="groupFilter">Select Group:</label>
                <select id="groupFilter">
                    <option value="all">All Groups</option>
                    <option value="Tier 2 IL">Tier 2 IL</option>
                    <option value="Tier 2 DUBAI">Tier 2 DUBAI</option>
                </select>

                <!-- Add a checkbox to toggle past dates visibility -->
                <label for="showPastDates">Show Past Dates</label>
                <input type="checkbox" id="showPastDates">
                
                <button class="collapsible">Vacations with Unavailable Members</button>
                <div class="content" id="vacations-body-wrapper">
                    <table id="vacations-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Vacationing Team Members</th>
                                <th>Group</th>
                                <th>Holiday</th>
                            </tr>
                        </thead>
                        <tbody id="vacations-body">
                            <!-- Vacation data will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Team members with their groups
        const TEAM_MEMBERS = {
            'Nadav Arnheim': 'Tier 2 IL',
            'Guy Kogan': 'Tier 2 IL',
            'Galit Bezinian Ezov': 'Tier 2 IL',
            'Hodaya Menahem': 'Tier 2 IL',
            'Netanel Balas': 'Tier 2 IL',
            'Abizar Fakruddin': 'Tier 2 DUBAI',
            'Yasin Banu Shafi Mohamed': 'Tier 2 DUBAI'
        };

        // Fetch and parse ICS data
        const fetchICSData = async () => {
            try {
                const response = await fetch('https://cal.hibob.com/31618/ics/44b3aa82-d1ac-482d-84d7-8dc7c638206f');
                const data = await response.text();
                return data;
            } catch (error) {
                console.error('Error fetching ICS data:', error);
                document.getElementById('loading-message').textContent = 'Error loading vacation data.';
                return '';
            }
        };

        // Parse ICS data into structured events
        const parseICSData = (icsData) => {
            const events = [];
            const eventPattern = /BEGIN:VEVENT([\s\S]+?)END:VEVENT/g;
            let match;
            while ((match = eventPattern.exec(icsData)) !== null) {
                const event = match[1];
                const summaryMatch = /SUMMARY:(.+?)(?:\r?\n|$)/.exec(event);
                const dtStartMatch = /DTSTART;VALUE=DATE:(\d{8})/.exec(event);
                const dtEndMatch = /DTEND;VALUE=DATE:(\d{8})/.exec(event);

                if (summaryMatch && dtStartMatch && dtEndMatch) {
                    const summary = summaryMatch[1].trim();
                    const holidayMatch = /^(.+?) -/.exec(summary);
                    const teamMember = Object.keys(TEAM_MEMBERS).find(name => 
                        summary.toLowerCase().includes(name.toLowerCase())
                    );

                    const holiday = holidayMatch && !summary.includes('Sick Day') && !summary.includes('Vacation') 
                        ? holidayMatch[1] 
                        : '';

                    if (teamMember) {
                        events.push({
                            summary: teamMember,
                            group: TEAM_MEMBERS[teamMember],
                            start: dtStartMatch[1],
                            end: dtEndMatch[1],
                            holiday: holiday
                        });
                    }
                }
            }
            return events;
        };

        // Group vacations by date and count
        const groupVacationsByDate = (events) => {
            const vacationsByDate = {};
            events.forEach(event => {
                const startDate = event.start;
                if (!vacationsByDate[startDate]) {
                    vacationsByDate[startDate] = {
                        members: [],
                        groups: new Set(),
                        holidays: new Set()
                    };
                }

                vacationsByDate[startDate].members.push(event.summary);
                vacationsByDate[startDate].groups.add(event.group);
                if (event.holiday) {
                    vacationsByDate[startDate].holidays.add(event.holiday);
                }
            });
            return vacationsByDate;
        };

        // Format date from YYYYMMDD to a more readable format
        const formatDate = (dateString) => {
            const year = dateString.slice(0, 4);
            const month = dateString.slice(4, 6);
            const day = dateString.slice(6, 8);
            return `${day}/${month}/${year}`;
        };

        // Filter vacations based on the number of unavailable members, past dates visibility, and selected group
        const filterVacations = (vacationsByDate, showPastDates, minUnavailableMembers, selectedGroup) => {
            const today = new Date().toISOString().split('T')[0].replace(/-/g, '');
            return Object.entries(vacationsByDate)
                .filter(([date, membersData]) => {
                    const memberCount = membersData.members.length;
                    const isGroupMatched = selectedGroup === 'all' || membersData.groups.has(selectedGroup);
                    return (showPastDates || date >= today) && memberCount >= minUnavailableMembers && isGroupMatched;
                })
                .map(([date, membersData]) => ({
                    date,
                    members: membersData.members,
                    groups: [...membersData.groups],
                    holidays: [...membersData.holidays]
                }));
        };

        // Update insights on the page
        const updateInsights = async () => {
            const icsData = await fetchICSData();
            const events = parseICSData(icsData);
            const vacationsByDate = groupVacationsByDate(events);

            // Get selected filters
            const showPastDates = document.getElementById('showPastDates').checked;
            const minUnavailableMembers = parseInt(document.getElementById('minUnavailableMembers').value);
            const selectedGroup = document.getElementById('groupFilter').value;

            // Filter vacations based on selected filters
            const filteredVacations = filterVacations(vacationsByDate, showPastDates, minUnavailableMembers, selectedGroup);

            // Update summary
            const summaryElement = document.getElementById('vacation-summary');
            summaryElement.innerHTML = `
                <h2>Vacation Summary</h2>
                <p>Total Vacations (ALL): ${events.length}</p>
                <p class="warning">Total Days (FILTER): ${filteredVacations.length}</p>
            `;

            // Populate vacations table
            const vacationsBody = document.getElementById('vacations-body');
            vacationsBody.innerHTML = filteredVacations.map(vacation => `
                <tr class="highlight">
                    <td>${formatDate(vacation.date)}</td>
                    <td>${[...new Set(vacation.members)].join(', ')}</td>
                    <td>${[...new Set(vacation.groups)].join(', ')}</td>
                    <td>${vacation.holidays.join(', ')}</td>
                </tr>
            `).join('');

            // Hide loading message
            document.getElementById('loading-message').style.display = 'none';
        };

        // Toggle collapsible tables
        const collapsibles = document.getElementsByClassName("collapsible");
        for (let i = 0; i < collapsibles.length; i++) {
            collapsibles[i].addEventListener("click", function() {
                this.classList.toggle("active");
                const content = this.nextElementSibling;
                if (content.style.display === "block") {
                    content.style.display = "none";
                } else {
                    content.style.display = "block";
                }
            });
        }

        // Add event listeners for filters
        document.getElementById('minUnavailableMembers').addEventListener('change', updateInsights);
        document.getElementById('showPastDates').addEventListener('change', updateInsights);
        document.getElementById('groupFilter').addEventListener('change', updateInsights);

        // Run insights on page load
        updateInsights();
    </script>
</body>
</html>
